(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6174],{12224:(e,a,t)=>{Promise.resolve().then(t.bind(t,37606))},37606:(e,a,t)=>{"use strict";t.d(a,{default:()=>n});var s=t(51833),l=t(59693);function n(){let[e,a]=(0,l.useState)([]),[t,n]=(0,l.useState)("all"),[c,r]=(0,l.useState)(""),[i,d]=(0,l.useState)(!1),[o,h]=(0,l.useState)(null),x=(0,l.useCallback)(async()=>{d(!0),h(null);let e=new URLSearchParams;"all"!==t&&e.set("status",t),c&&e.set("q",c);let s=await fetch("/api/read/compliance/checklist?".concat(e.toString()),{cache:"no-store"});if(!s.ok){h("load failed"),a([]),d(!1);return}a((await s.json()).items),d(!1)},[t,c]);(0,l.useEffect)(()=>{(async()=>{await x().catch(console.error)})()},[x]);let u=(0,l.useMemo)(()=>e.reduce((e,a)=>(e.total+=1,"pass"===a.status?e.pass+=1:"warn"===a.status?e.warn+=1:e.fail+=1,e),{total:0,pass:0,warn:0,fail:0}),[e]),[p,m]=(0,l.useState)(null),[j,f]=(0,l.useState)("");async function N(e){try{if(!(await fetch("/api/control/compliance/checklist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item:{key:e,evidenceUrl:j},actor:"ui"})})).ok)throw Error("attach failed");m(null),f(""),await x()}catch(e){alert("Error adjuntando evidencia")}}async function b(t,s){let l=e.slice();a(e=>e.map(e=>e.key===t?{...e,status:s}:e));try{if(!(await fetch("/api/control/compliance/checklist",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item:{key:t,status:s},actor:"ui"})})).ok)throw Error("save failed")}catch(e){a(l),alert("Error al cambiar estado")}}return(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)("button",{className:"text-xs px-2 py-1 rounded border ".concat("all"===t?"bg-slate-900 text-white":""),onClick:()=>n("all"),children:["All (",u.total,")"]}),(0,s.jsxs)("button",{className:"text-xs px-2 py-1 rounded border ".concat("pass"===t?"bg-slate-900 text-white":""),onClick:()=>n("pass"),children:["Pass (",u.pass||0,")"]}),(0,s.jsxs)("button",{className:"text-xs px-2 py-1 rounded border ".concat("warn"===t?"bg-slate-900 text-white":""),onClick:()=>n("warn"),children:["Warn (",u.warn||0,")"]}),(0,s.jsxs)("button",{className:"text-xs px-2 py-1 rounded border ".concat("fail"===t?"bg-slate-900 text-white":""),onClick:()=>n("fail"),children:["Fail (",u.fail||0,")"]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{className:"border rounded px-2 py-1",placeholder:"Buscar key o t\xedtulo",value:c,onChange:e=>r(e.target.value)}),(0,s.jsx)("button",{className:"text-sm underline",onClick:()=>x(),children:"Buscar"})]})]}),(0,s.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"text-left p-2",children:"Key"}),(0,s.jsx)("th",{className:"text-left p-2",children:"T\xedtulo"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Estado"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Evidencia"}),(0,s.jsx)("th",{className:"text-left p-2",children:"UpdatedAt"}),(0,s.jsx)("th",{className:"text-left p-2",children:"UpdatedBy"}),(0,s.jsx)("th",{className:"p-2",children:"Acciones"})]})}),(0,s.jsxs)("tbody",{children:[e.map(e=>{var a;return(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2 font-mono",children:e.key}),(0,s.jsx)("td",{className:"p-2",children:e.title}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsxs)("select",{className:"border rounded px-2 py-1",value:e.status,onChange:a=>b(e.key,a.target.value),children:[(0,s.jsx)("option",{value:"pass",children:"pass"}),(0,s.jsx)("option",{value:"warn",children:"warn"}),(0,s.jsx)("option",{value:"fail",children:"fail"})]})}),(0,s.jsx)("td",{className:"p-2",children:e.evidenceUrl?(0,s.jsx)("a",{href:e.evidenceUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 underline",children:"evidencia"}):(0,s.jsx)("span",{className:"text-gray-400",children:"—"})}),(0,s.jsx)("td",{className:"p-2 whitespace-nowrap",children:new Date(e.updatedAt).toLocaleString()}),(0,s.jsx)("td",{className:"p-2",children:null!=(a=e.updatedBy)?a:"—"}),(0,s.jsx)("td",{className:"p-2 text-right",children:(0,s.jsx)("button",{className:"text-xs underline",onClick:()=>{m({open:!0,key:e.key}),f("")},children:"Adjuntar evidencia"})})]},e.id)}),0===e.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"p-2 text-gray-500",colSpan:7,children:i?"Cargando…":o?"Error":"Sin datos"})})]})]})}),(null==p?void 0:p.open)&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center",children:(0,s.jsxs)("div",{className:"bg-white text-black rounded p-4 w-[420px]",children:[(0,s.jsx)("h3",{className:"font-semibold mb-2",children:"Adjuntar evidencia"}),(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-full",placeholder:"https://…",value:j,onChange:e=>f(e.target.value)}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 mt-3",children:[(0,s.jsx)("button",{onClick:()=>m(null),className:"px-3 py-1",children:"Cancelar"}),(0,s.jsx)("button",{onClick:()=>(null==p?void 0:p.key)&&N(p.key),className:"bg-blue-600 text-white px-3 py-1 rounded",children:"Guardar"})]})]})})]})}}},e=>{e.O(0,[9959,1413,7358],()=>e(e.s=12224)),_N_E=e.O()}]);