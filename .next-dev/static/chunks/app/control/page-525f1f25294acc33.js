(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2580],{8327:(e,a,t)=>{"use strict";t.d(a,{A:()=>s});let s=(0,t(11097).A)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},28213:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>c});var s=t(51833),r=t(59693);function l(){let[e,a]=(0,r.useState)(!1),[t,l]=(0,r.useState)(null),n=async()=>{a(!0);try{let e=await fetch("/api/agents/process",{method:"POST"}),a=await e.json();l(a)}finally{a(!1)}};return(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{onClick:n,disabled:e,className:"rounded border px-3 py-1 text-sm hover:bg-accent",children:e?"Procesandoâ€¦":"Run worker once"}),t&&(0,s.jsx)("code",{className:"text-xs opacity-70",children:JSON.stringify(t)})]})}var n=t(98574);function c(){let[e,a]=(0,r.useState)([]),t=Array.isArray(e)?e:[],[c,i]=(0,r.useState)([]),[d,o]=(0,r.useState)(!1),[u,x]=(0,r.useState)([]),[m,h]=(0,r.useState)(""),[p,f]=(0,r.useState)({agentCode:"",name:"",expr:'{"kind":"keyword","field":"news.title","anyOf":["hack","exploit"],"severity":"high"}',enabled:!0}),[g,j]=(0,r.useState)(""),[N,b]=(0,r.useState)("");function y(e){b(e),setTimeout(()=>b(""),2500)}let v=(0,r.useCallback)(async()=>{let e=await fetch("/api/control/limits",{cache:"no-store"});i(await e.json())},[]),w=(0,r.useCallback)(async()=>{let e=m?"/api/control/rules?agentCode=".concat(encodeURIComponent(m)):"/api/control/rules",a=await fetch(e,{cache:"no-store"});x(await a.json())},[m]),k=(0,r.useCallback)(async()=>{let e=g?"/api/read/audit?entity=".concat(encodeURIComponent(g)):"/api/read/audit",t=await fetch(e,{cache:"no-store"}),s=await t.json();a(Array.isArray(s)?s:[])},[g]);(0,r.useEffect)(()=>{v().catch(console.error)},[v]),(0,r.useEffect)(()=>{w().catch(console.error)},[w]),(0,r.useEffect)(()=>{k().catch(console.error)},[k]);let C=(e,a)=>{i(t=>t.map((t,s)=>s===e?{...t,...a}:t))},S=async e=>{try{var a;if(o(!0),!(await fetch("/api/control/limits",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:e.key,value:Number(e.value),notes:null!=(a=e.notes)?a:void 0,actor:"ui"})})).ok)throw Error("save failed");await v(),y("Guardado ".concat(e.key))}catch(e){y("Error al guardar l\xedmite")}finally{o(!1)}},E=async()=>{try{let e=JSON.parse(p.expr);if(!(await fetch("/api/control/rules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...p,expr:e,actor:"ui"})})).ok)throw Error("create failed");f({agentCode:"",name:"",expr:'{"kind":"keyword","field":"news.title","anyOf":["hack","exploit"],"severity":"high"}',enabled:!0}),await w(),y("Regla creada")}catch(e){y("Expr inv\xe1lida o error al crear")}};return(0,s.jsx)(n.NavigationGuard,{fallbackUrl:"/",storageKey:"control-panel",children:(0,s.jsxs)("main",{className:"max-w-6xl mx-auto px-4 py-10",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold",children:"Panel de Control"}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("a",{href:"/control/compliance",className:"text-sm underline",children:"Cumplimiento"}),(0,s.jsx)(l,{})]})]}),!!N&&(0,s.jsx)("div",{className:"mb-4 rounded bg-green-100 text-green-800 px-3 py-2 text-sm",children:N}),(0,s.jsxs)("section",{className:"mb-10",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Guardrails (Limits)"}),(0,s.jsx)("button",{className:"text-sm underline",onClick:()=>v(),children:"Refrescar"})]}),(0,s.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"text-left p-2",children:"Key"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Value"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Notes"}),(0,s.jsx)("th",{className:"p-2",children:"Acciones"})]})}),(0,s.jsxs)("tbody",{children:[c.map((e,a)=>{var t;return(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2 font-mono",children:e.key}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-32",type:"number",step:"0.0001",value:e.value,onChange:e=>C(a,{value:Number(e.target.value)})})}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-full",value:null!=(t=e.notes)?t:"",onChange:e=>C(a,{notes:e.target.value})})}),(0,s.jsx)("td",{className:"p-2 text-right",children:(0,s.jsx)("button",{disabled:d,onClick:()=>S(e),className:"bg-blue-600 text-white px-3 py-1 rounded disabled:opacity-50",children:"Guardar"})})]},e.key)}),0===c.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"p-2 text-gray-500",colSpan:4,children:"Sin datos"})})]})]})})]}),(0,s.jsxs)("section",{className:"mb-10",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Reglas"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{placeholder:"Filtrar por agentCode (p.ej. NM-1)",className:"border rounded px-2 py-1",value:m,onChange:e=>h(e.target.value)}),(0,s.jsx)("button",{className:"text-sm underline",onClick:()=>w(),children:"Refrescar"})]})]}),(0,s.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{className:"border rounded p-3",children:[(0,s.jsx)("h3",{className:"font-semibold mb-2",children:"Nueva regla"}),(0,s.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,s.jsx)("input",{placeholder:"agentCode (NM-1, OC-1, OP-X)",className:"border rounded px-2 py-1",value:p.agentCode,onChange:e=>f({...p,agentCode:e.target.value})}),(0,s.jsx)("input",{placeholder:"name",className:"border rounded px-2 py-1",value:p.name,onChange:e=>f({...p,name:e.target.value})}),(0,s.jsx)("label",{className:"text-xs text-gray-600",children:"Expr (JSON)"}),(0,s.jsx)("textarea",{rows:6,className:"border rounded px-2 py-1 font-mono",value:p.expr,onChange:e=>f({...p,expr:e.target.value})}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{id:"enabled",type:"checkbox",checked:p.enabled,onChange:e=>f({...p,enabled:e.target.checked})}),(0,s.jsx)("label",{htmlFor:"enabled",children:"Enabled"})]}),(0,s.jsx)("button",{onClick:E,className:"bg-green-600 text-white px-3 py-1 rounded",children:"Crear regla"})]})]}),(0,s.jsxs)("div",{className:"border rounded p-3 overflow-x-auto",children:[(0,s.jsx)("h3",{className:"font-semibold mb-2",children:"Listado"}),(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"text-left p-2",children:"Agent"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Name"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Enabled"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Expr"})]})}),(0,s.jsxs)("tbody",{children:[u.map(e=>(0,s.jsxs)("tr",{className:"border-t align-top",children:[(0,s.jsx)("td",{className:"p-2 font-mono",children:e.agentCode}),(0,s.jsx)("td",{className:"p-2",children:e.name}),(0,s.jsx)("td",{className:"p-2",children:e.enabled?"yes":"no"}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("pre",{className:"whitespace-pre-wrap text-xs bg-gray-50 p-2 rounded",children:JSON.stringify(e.expr,null,2)})})]},e.id)),0===u.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"p-2 text-gray-500",colSpan:4,children:"Sin reglas"})})]})]})]})]})]}),(0,s.jsxs)("section",{className:"mb-10",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Auditor\xeda"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{placeholder:"entity (Limit|Rule)",className:"border rounded px-2 py-1",value:g,onChange:e=>j(e.target.value)}),(0,s.jsx)("button",{className:"text-sm underline",onClick:()=>k(),children:"Refrescar"})]})]}),(0,s.jsx)("div",{className:"overflow-x-auto border rounded",children:(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"text-left p-2",children:"At"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Actor"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Entity"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Field"}),(0,s.jsx)("th",{className:"text-left p-2",children:"Old"}),(0,s.jsx)("th",{className:"text-left p-2",children:"New"})]})}),(0,s.jsx)("tbody",{children:Array.isArray(t)&&t.length>0?t.map(e=>{var a,t,r,l;return(0,s.jsxs)("tr",{className:"border-t align-top",children:[(0,s.jsx)("td",{className:"p-2 whitespace-nowrap",children:e.at&&!isNaN(Date.parse(e.at))?new Date(e.at).toLocaleString():""}),(0,s.jsx)("td",{className:"p-2",children:null!=(a=e.actor)?a:""}),(0,s.jsxs)("td",{className:"p-2",children:[null!=(t=e.entity)?t:"",":",null!=(r=e.entityId)?r:""]}),(0,s.jsx)("td",{className:"p-2",children:null!=(l=e.field)?l:""}),(0,s.jsx)("td",{className:"p-2 max-w-sm",children:(0,s.jsx)("pre",{className:"text-xs whitespace-pre-wrap",children:JSON.stringify(e.old,null,2)})}),(0,s.jsx)("td",{className:"p-2 max-w-sm",children:(0,s.jsx)("pre",{className:"text-xs whitespace-pre-wrap",children:JSON.stringify(e.new,null,2)})})]},e.id)}):(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"p-2 text-gray-500",colSpan:6,children:"Sin cambios"})})})]})})]})]})})}},36582:(e,a,t)=>{Promise.resolve().then(t.bind(t,28213))},70994:(e,a,t)=>{"use strict";t.d(a,{Cf:()=>u,Es:()=>m,L3:()=>h,c7:()=>x,lG:()=>c,rr:()=>p,zM:()=>i});var s=t(51833);t(59693);var r=t(87676),l=t(66846),n=t(81429);function c(e){let{...a}=e;return(0,s.jsx)(r.bL,{"data-slot":"dialog",...a})}function i(e){let{...a}=e;return(0,s.jsx)(r.l9,{"data-slot":"dialog-trigger",...a})}function d(e){let{...a}=e;return(0,s.jsx)(r.ZL,{"data-slot":"dialog-portal",...a})}function o(e){let{className:a,...t}=e;return(0,s.jsx)(r.hJ,{"data-slot":"dialog-overlay",className:(0,n.cn)("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",a),...t})}function u(e){let{className:a,children:t,showCloseButton:c=!0,...i}=e;return(0,s.jsxs)(d,{"data-slot":"dialog-portal",children:[(0,s.jsx)(o,{}),(0,s.jsxs)(r.UC,{"data-slot":"dialog-content",className:(0,n.cn)("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",a),...i,children:[t,c&&(0,s.jsxs)(r.bm,{"data-slot":"dialog-close",className:"ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",children:[(0,s.jsx)(l.A,{}),(0,s.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})}function x(e){let{className:a,...t}=e;return(0,s.jsx)("div",{"data-slot":"dialog-header",className:(0,n.cn)("flex flex-col gap-2 text-center sm:text-left",a),...t})}function m(e){let{className:a,...t}=e;return(0,s.jsx)("div",{"data-slot":"dialog-footer",className:(0,n.cn)("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",a),...t})}function h(e){let{className:a,...t}=e;return(0,s.jsx)(r.hE,{"data-slot":"dialog-title",className:(0,n.cn)("text-lg leading-none font-semibold",a),...t})}function p(e){let{className:a,...t}=e;return(0,s.jsx)(r.VY,{"data-slot":"dialog-description",className:(0,n.cn)("text-muted-foreground text-sm",a),...t})}},83738:(e,a,t)=>{"use strict";var s=t(81678);t.o(s,"useParams")&&t.d(a,{useParams:function(){return s.useParams}}),t.o(s,"usePathname")&&t.d(a,{usePathname:function(){return s.usePathname}}),t.o(s,"useRouter")&&t.d(a,{useRouter:function(){return s.useRouter}}),t.o(s,"useSearchParams")&&t.d(a,{useSearchParams:function(){return s.useSearchParams}})},85127:(e,a,t)=>{"use strict";t.d(a,{A:()=>s});let s=(0,t(11097).A)("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},98574:(e,a,t)=>{"use strict";t.d(a,{NavigationGuard:()=>h});var s=t(51833),r=t(59693),l=t(30249),n=t.n(l),c=t(83738),i=t(11622),d=t(70994),o=t(8327),u=t(66846),x=t(85127),m=t(4991);function h(e){var a;let{hasUnsavedChanges:t=!1,onSave:l,data:h,storageKey:p,children:f,showBackButton:g=!0,backUrl:j,fallbackUrl:N="/"}=e,b=(0,c.useRouter)(),y=(0,c.usePathname)(),{toast:v}=(0,m.dj)(),[w,k]=(0,r.useState)(!1),[C,S]=(0,r.useState)(null),[E,A]=(0,r.useState)(!1),O=(0,r.useCallback)(async()=>{if(h&&p)try{let e={data:h,timestamp:Date.now(),pathname:y,expiresAt:Date.now()+2592e6};localStorage.setItem("adaf_autosave_".concat(p),JSON.stringify(e))}catch(e){console.warn("Failed to auto-save data:",e)}},[h,p,y]);(0,r.useEffect)(()=>{if(t&&h){let e=setInterval(O,3e4);return()=>clearInterval(e)}},[t,h,O]),(0,r.useEffect)(()=>{Object.keys(localStorage).filter(e=>e.startsWith("adaf_autosave_")).forEach(e=>{try{let a=JSON.parse(localStorage.getItem(e)||"{}");a.expiresAt&&a.expiresAt<Date.now()&&localStorage.removeItem(e)}catch(a){localStorage.removeItem(e)}})},[]);let P=(0,r.useCallback)(()=>j||(window.history.length>1?"back":N),[j,N]),L=(0,r.useMemo)(()=>P(),[P]),R="back"===L?null!=(a=null!=j?j:N)?a:"/":L;(0,r.useEffect)(()=>{let e=e=>{t&&(e.preventDefault(),e.returnValue="\xbfDesea salir sin guardar? Los datos se guardar\xe1n autom\xe1ticamente.",O())},a=e=>{t&&(e.preventDefault(),k(!0),S("back"),window.history.pushState(null,"",window.location.href))};return window.addEventListener("beforeunload",e),window.addEventListener("popstate",a),()=>{window.removeEventListener("beforeunload",e),window.removeEventListener("popstate",a)}},[t,O]);let D=async()=>{if(l){A(!0);try{await l(),v({title:"Datos guardados",description:"Los datos se han guardado correctamente."})}catch(e){v({title:"Error al guardar",description:"No se pudieron guardar los datos. Se guardar\xe1n autom\xe1ticamente.",variant:"destructive"})}finally{A(!1)}}await O(),k(!1);let e=null!=C?C:L;"back"===e?b.back():b.push(e)},_=async()=>{await O(),k(!1);let e=null!=C?C:L;"back"===e?b.back():b.push(e)};return(0,s.jsxs)(s.Fragment,{children:[g&&(t?(0,s.jsxs)(i.$,{variant:"ghost",size:"sm",onClick:()=>{if(t){k(!0),S(L);return}"back"===L?b.back():b.push(L)},className:"mb-4 text-muted-foreground hover:text-foreground",children:[(0,s.jsx)(o.A,{className:"w-4 h-4 mr-2"}),"Regresar"]}):(0,s.jsx)(i.$,{asChild:!0,variant:"ghost",size:"sm",className:"mb-4 text-muted-foreground hover:text-foreground",children:(0,s.jsxs)(n(),{href:R,prefetch:!1,children:[(0,s.jsx)(o.A,{className:"w-4 h-4 mr-2"}),"Regresar"]})})),f,(0,s.jsx)(d.lG,{open:w,onOpenChange:k,children:(0,s.jsxs)(d.Cf,{children:[(0,s.jsxs)(d.c7,{children:[(0,s.jsxs)(d.L3,{className:"flex items-center gap-2",children:[(0,s.jsx)(u.A,{className:"w-5 h-5 text-destructive"}),"\xbfDesea salir de esta p\xe1gina?"]}),(0,s.jsxs)(d.rr,{children:["Tienes cambios sin guardar. \xbfQu\xe9 deseas hacer?",(0,s.jsx)("br",{}),(0,s.jsx)("span",{className:"text-xs text-muted-foreground mt-2 block",children:"\uD83D\uDCA1 Los datos se guardan autom\xe1ticamente cada 30 segundos y se conservan por 30 d\xedas."})]})]}),(0,s.jsxs)(d.Es,{className:"gap-2",children:[(0,s.jsx)(i.$,{variant:"outline",onClick:()=>{k(!1),S(null)},children:"Quedarse"}),(0,s.jsx)(i.$,{variant:"secondary",onClick:_,children:"Salir sin guardar"}),(0,s.jsxs)(i.$,{onClick:D,disabled:E,className:"gap-2",children:[(0,s.jsx)(x.A,{className:"w-4 h-4"}),E?"Guardando...":"Guardar y salir"]})]})]})})]})}}},e=>{e.O(0,[3701,6333,249,3060,3389,4802,7913,5034,9959,1413,7358],()=>e(e.s=36582)),_N_E=e.O()}]);