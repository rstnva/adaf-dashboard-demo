"use strict";(()=>{var a={};a.id=722,a.ids=[722],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},5365:(a,b,c)=>{c.d(b,{g:()=>l});var d=c(53307),e=c(20554);let f=e.Ik({dxy:e.ai(),ust2y:e.ai(),ust10y:e.ai(),spread2s10s:e.ai(),ts:e.ai()});var g=c(53452),h=c(57849),i=c(58824);let j=Number(process.env.WSP_CACHE_TTL_SEC||180),k="ratesFx";async function l(){let a=process.env.WSP_RATES_API_URL||process.env.RATES_FX_API_URL||"",b=process.env.WSP_RATES_API_KEY||process.env.RATES_FX_API_KEY||"";if(!(0,g.YV)("wsp:rates",5,10))throw Error("rate_limited");if(!(0,g.NF)(k))throw Error("circuit_open");let c=b?{Authorization:`Bearer ${b}`}:{},e=Date.now();try{let{body:b,status:l,stale:m}=await (0,g.EQ)(k,a,"ratesFx:last",j,c),n=JSON.parse(b),o=f.parse(n);if((0,d.m8)(k,l,Date.now()-e),304===l&&(0,d.Zl)("redis"),m&&(0,d.Zl)("etag"),(0,g.jb)(k),!m&&200===l&&"number"==typeof o.dxy){let a=await (0,h.uq)(h.qk.dxy),b=(0,i.DD)(a||void 0,o.dxy);await (0,h.Jt)(h.qk.dxy,b)}return{data:o,stale:m}}catch(a){throw(0,g.IT)(k),(0,d.m8)(k,500,Date.now()-e),a}}},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19771:a=>{a.exports=require("process")},24753:(a,b,c)=>{c.d(b,{u:()=>l});var d=c(53307),e=c(20554);let f=e.Ik({spx:e.ai(),ndx:e.ai(),vix:e.ai(),ts:e.ai(),dChange:e.Ik({spx:e.ai(),ndx:e.ai(),vix:e.ai()}).optional()});var g=c(53452),h=c(57849),i=c(58824);let j=Number(process.env.WSP_CACHE_TTL_SEC||180),k="indices";async function l(){let a=process.env.WSP_INDICES_API_URL||process.env.INDICES_API_URL||"",b=process.env.WSP_INDICES_API_KEY||process.env.INDICES_API_KEY||"";if(!(0,g.YV)("wsp:indices",5,10))throw Error("rate_limited");if(!(0,g.NF)(k))throw Error("circuit_open");let c=b?{Authorization:`Bearer ${b}`}:{},e=Date.now();try{let{body:b,status:l,stale:m}=await (0,g.EQ)(k,a,"indices:last",j,c),n=JSON.parse(b),o=f.parse(n);if((0,d.m8)(k,l,Date.now()-e),304===l&&(0,d.Zl)("redis"),m&&(0,d.Zl)("etag"),(0,g.jb)(k),!m&&200===l&&"number"==typeof o.vix){let a=await (0,h.uq)(h.qk.vix),b=(0,i.DD)(a||void 0,o.vix);await (0,h.Jt)(h.qk.vix,b)}return{data:o,stale:m}}catch(a){throw(0,g.IT)(k),(0,d.m8)(k,500,Date.now()-e),a}}},27172:a=>{a.exports=require("cluster")},28354:a=>{a.exports=require("util")},29021:a=>{a.exports=require("fs")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},32310:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>P,patchFetch:()=>O,routeModule:()=>K,serverHooks:()=>N,workAsyncStorage:()=>L,workUnitAsyncStorage:()=>M});var d={};c.r(d),c.d(d,{GET:()=>J});var e=c(70818),f=c(73659),g=c(27002),h=c(69532),i=c(40386),j=c(261),k=c(8404),l=c(92638),m=c(35254),n=c(92229),o=c(53203),p=c(29865),q=c(25183),r=c(7896),s=c(86439),t=c(15974);let u={ETF_BTC:.25,ETF_ETH:.1,VIX:.2,DXY:.15,SPREAD_2s10s:.1,SPX_NDX:.2},v={green:66,yellow:33};var w=c(53452),x=c(53307),y=c(57849);let z="wsp:wsps:ema",A="wsp:wsps:band",B=null,C=null;async function D(a,b=.2,c=3){let d=await w.Rn.get(z),e=await w.Rn.get(A),f=d?Number(d):B??a,g=e||C||"red",h=Math.round(b*a+(1-b)*f),i=h>=v.green?"green":h>=v.yellow?"yellow":"red",j=g;"yellow"===g?h>=v.green+c?j="green":h<v.yellow-c&&(j="red"):"green"===g?h<v.green-c&&(j=i):h>=v.yellow+c&&(j=i);try{await w.Rn.set(z,String(h),86400),await w.Rn.set(A,j,86400)}catch{B=h,C=j}return(0,x.uT)(h),{score:h,color:j,smoothing:{ema:!0,hysteresis:{bandMargin:c}}}}function E(a,b,c){return Math.max(b,Math.min(c,a))}async function F(a){let[b,c,d,e]=await Promise.all([y.uq(y.qk.vix),y.uq(y.qk.dxy),y.g5(y.qk.etfBtc),y.g5(y.qk.etfEth)]),f=18,g=6,h=100,i=4,j=-5e7,k=25e7,l="fallback",m=b?.mean??f,n=b&&b.count>=2?Math.sqrt(b.m2/(b.count-1)):g;l=b&&b.count>=2?"redis":"fallback";let o=a=>E(a,-2.5,2.5),p=null!=a.vix?1-o((a.vix-m)/(n||1)):.5,q="fallback",r=c?.mean??h,s=c&&c.count>=2?Math.sqrt(c.m2/(c.count-1)):i;q=c&&c.count>=2?"redis":"fallback";let t=null!=a.dxy?1-o((a.dxy-r)/(s||1)):.5,u="fallback",v="fallback",w=d?new Number(d.p5?.q?.[2]??j).valueOf():j,x=d?new Number(d.p95?.q?.[2]??k).valueOf():k,z=e?new Number(e.p5?.q?.[2]??j).valueOf():j,A=e?new Number(e.p95?.q?.[2]??k).valueOf():k;function B(a,b,c){if(null==a)return .5;let d=c-b;return!isFinite(d)||1e-6>Math.abs(d)?E((a-j)/(k-j),0,1):E((a-b)/d,0,1)}u=d?"redis":"fallback",v=e?"redis":"fallback";let C=B(a.etfBtcFlow,w,x),D=B(a.etfEthFlow,z,A),F=null!=a.spread2s10s?E((a.spread2s10s+1)/2,0,1):.5;return{inputs:{ETF_BTC_FLOW_NORM:C,ETF_ETH_FLOW_NORM:D,VIX_NORM:p,DXY_NORM:t,SPREAD_2s10s_NORM:F,SPX_NDX_MOM_NORM:a.spxNdXMom?E((a.spxNdXMom.ndx+a.spxNdXMom.spx+4)/8,0,1):.5},normalization:{source:"redis"===l||"redis"===q||"redis"===u||"redis"===v?"redis":"fallback"}}}var G=c(90701),H=c(5365),I=c(24753);async function J(a){let b=Date.now();try{if(!(0,w.YV)("route:wsp:wsps",5,10))return new Response(JSON.stringify({error:"rate_limited"}),{status:429});let[a,c,d]=await Promise.all([(0,G.X)({asset:"BTC",window:"1d"}),(0,H.g)(),(0,I.u)()]),e=!!(a?.stale||c?.stale||d?.stale),f=a?.data?.[0]?.netFlowUSD??null,g=d?.data?.vix??null,h=c?.data?.dxy??null,i=c?.data?.spread2s10s??null,j=d?.data?.dChange?{spx:d.data.dChange.spx,ndx:d.data.dChange.ndx}:null,{inputs:k,normalization:l}=await F({vix:g,dxy:h,etfBtcFlow:f,etfEthFlow:null,spread2s10s:i,spxNdXMom:j}),m=function(a){let b=[{name:"ETF_BTC",value:a.ETF_BTC_FLOW_NORM,weight:u.ETF_BTC},{name:"ETF_ETH",value:a.ETF_ETH_FLOW_NORM,weight:u.ETF_ETH},{name:"VIX",value:a.VIX_NORM,weight:u.VIX},{name:"DXY",value:a.DXY_NORM,weight:u.DXY},{name:"SPREAD_2s10s",value:a.SPREAD_2s10s_NORM,weight:u.SPREAD_2s10s},{name:"SPX_NDX",value:a.SPX_NDX_MOM_NORM,weight:u.SPX_NDX}].map(a=>({...a,contribution:a.value*a.weight})),c=Math.round(100*b.reduce((a,b)=>a+b.contribution,0)),d="red";return c>=v.green?d="green":c>=v.yellow&&(d="yellow"),{score:c,color:d,breakdown:b}}(k),n=await D(m.score,.2,3),o=Date.now()-b;return(0,x.V6)("/api/wsp/wsps",200,o),new Response(JSON.stringify({score:n.score,color:n.color,factors:m.breakdown,ts:Date.now(),smoothing:n.smoothing,stale:e,normalization:l}),{status:200,headers:new Headers({"content-type":"application/json",...e?{"X-WSP-Data":"stale"}:{}})})}catch(a){return(0,x.V6)("/api/wsp/wsps",502),new Response(JSON.stringify({error:a instanceof Error?a.message:"unknown_error"}),{status:502})}}let K=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/wsp/wsps/route",pathname:"/api/wsp/wsps",filename:"route",bundlePath:"app/api/wsp/wsps/route"},distDir:".next-dev",relativeProjectDir:"",resolvedPagePath:"/home/parallels/Desktop/adaf-dashboard-pro/src/app/api/wsp/wsps/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:L,workUnitAsyncStorage:M,serverHooks:N}=K;function O(){return(0,g.patchFetch)({workAsyncStorage:L,workUnitAsyncStorage:M})}async function P(a,b,c){var d;let e="/api/wsp/wsps/route";"/index"===e&&(e="/");let g=await K.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||K.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===K.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),L=J.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>K.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>K.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await K.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await K.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await K.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:a=>{a.exports=require("https")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:a=>{a.exports=require("zlib")},74998:a=>{a.exports=require("perf_hooks")},77824:a=>{a.exports=require("v8")},79551:a=>{a.exports=require("url")},81630:a=>{a.exports=require("http")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},90701:(a,b,c)=>{c.d(b,{X:()=>l});var d=c(53307),e=c(20554);let f=e.Ik({date:e.Yj(),asset:e.k5(["BTC","ETH"]),issuer:e.Yj().optional(),netFlowUSD:e.ai(),cumFlowUSD:e.ai().optional()});var g=c(53452),h=c(57849),i=c(58824);let j=Number(process.env.WSP_CACHE_TTL_SEC||180),k="etfFlow";async function l({asset:a,window:b}){let c=process.env.WSP_ETF_API_URL||process.env.ETF_FLOW_API_URL||"",e=process.env.WSP_ETF_API_KEY||process.env.ETF_FLOW_API_KEY||"",l=`etfFlow:${a}:${b}`;if(!(0,g.YV)("wsp:etf",5,10))throw Error("rate_limited");if(!(0,g.NF)(k))throw Error("circuit_open");let m=`${c}?asset=${a}&window=${b}`,n=e?{Authorization:`Bearer ${e}`}:{},o=Date.now();try{let{body:b,status:c,stale:e}=await (0,g.EQ)(k,m,l,j,n),p=JSON.parse(b),q=f.array().parse(p);if((0,d.m8)(k,c,Date.now()-o),304===c&&(0,d.Zl)("redis"),e&&(0,d.Zl)("etag"),(0,g.jb)(k),!e&&200===c&&q.length>0){let b=q[0]?.netFlowUSD;if("number"==typeof b){let c="BTC"===a?h.qk.etfBtc:h.qk.etfEth,d=await (0,h.g5)(c),e=(0,i.BT)(b,d?.p5,d?.p95);await (0,h.dE)(c,e)}}return{data:q,stale:e}}catch(a){throw(0,g.IT)(k),(0,d.m8)(k,500,Date.now()-o),a}}}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[246,29,8173,4903],()=>b(b.s=32310));module.exports=c})();