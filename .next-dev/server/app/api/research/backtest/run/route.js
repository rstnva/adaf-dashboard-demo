(()=>{var a={};a.id=5307,a.ids=[5307],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},25578:(a,b,c)=>{"use strict";c.d(b,{YO:()=>k});var d=c(41315);class e{get(a){let b=this.store.get(a);return b?Date.now()>b.expires?(this.store.delete(a),null):b.data:null}set(a,b,c=36e5){this.store.set(a,{data:b,expires:Date.now()+c})}delete(a){this.store.delete(a)}cleanup(){let a=Date.now();for(let[b,c]of this.store.entries())a>c.expires&&this.store.delete(b)}constructor(){this.store=new Map}}class f{constructor(){this.client=null}async get(a){if(!this.client)return null;try{let b=await this.client.get(a);return b?JSON.parse(b):null}catch(a){return console.error("Redis get error:",a),null}}async set(a,b,c=3600){if(this.client)try{await this.client.setex(a,c,JSON.stringify(b))}catch(a){console.error("Redis set error:",a)}}}class g{constructor(){this.memoryStore=new e,this.redisStore=new f,this.cleanupInterval=setInterval(()=>{this.memoryStore.cleanup()},3e5)}async checkLimit(a,b,c){let d=`rl:${b}:${a}`,e=Date.now();try{let a=this.memoryStore.get(d)||await this.redisStore.get(d);a||(a={tokens:c,lastRefill:e,capacity:c,refillRate:c});let b=(e-a.lastRefill)/6e4,f=Math.floor(b*a.refillRate);if(f>0&&(a.tokens=Math.min(a.capacity,a.tokens+f),a.lastRefill=e),a.tokens<=0)return this.memoryStore.set(d,a),await this.redisStore.set(d,a,3600),{allowed:!1,remainingTokens:0,resetTime:a.lastRefill+6e4,error:"rate_limit_exceeded"};return a.tokens-=1,this.memoryStore.set(d,a),await this.redisStore.set(d,a,3600),{allowed:!0,remainingTokens:a.tokens,resetTime:a.lastRefill+6e4}}catch(a){return console.error("Rate limit check error:",a),{allowed:!0,remainingTokens:c,resetTime:e+6e4,error:"rate_limit_error"}}}getClientIP(a){let b=a.headers.get("x-forwarded-for");if(b)return b.split(",")[0].trim();let c=a.headers.get("x-real-ip");if(c)return c;let d=a.headers.get("cf-connecting-ip");return d||"127.0.0.1"}getRoutePattern(a){return a.replace(/\/\d+/g,"/[id]").replace(/\/[a-f0-9-]{36}/g,"/[uuid]").replace(/\/\w{8}-\w{4}-\w{4}-\w{4}-\w{12}/g,"/[guid]")}cleanup(){this.cleanupInterval&&clearInterval(this.cleanupInterval)}}let h=null,i={"/api/actions/*":parseInt(process.env.RATE_ACTIONS_PER_MIN||"10"),"/api/control/*":parseInt(process.env.RATE_ACTIONS_PER_MIN||"10"),"/api/research/backtest/run":parseInt(process.env.RATE_RESEARCH_RUN_PER_MIN||"6"),"/api/generate/report/*":parseInt(process.env.RATE_REPORTS_PER_MIN||"5"),"/api/read/*":parseInt(process.env.RATE_DEFAULT_PER_MIN||"120"),"/api/research/*":parseInt(process.env.RATE_DEFAULT_PER_MIN||"120"),"*":parseInt(process.env.RATE_DEFAULT_PER_MIN||"120")},j=["/api/metrics","/api/stream/alerts","/api/healthz"];async function k(a,b){let c=new URL(a.url).pathname;if(j.some(a=>c.startsWith(a)))return b(a);let e=function(a){if(j.some(b=>a.startsWith(b)))return 0;for(let[b,c]of Object.entries(i))if("*"!==b&&RegExp("^"+b.replace(/\*/g,".*")+"$").test(a))return c;return i["*"]}(c);if(0===e)return b(a);try{let f=(h||(h=new g),h),i=function(a){let b=a.headers.get("x-forwarded-for");if(b)return b.split(",")[0].trim();let c=a.headers.get("x-real-ip");if(c)return c;let d=a.headers.get("cf-connecting-ip");return d||"127.0.0.1"}(a),j=f.getRoutePattern(c),k=await f.checkLimit(i,j,e);if(!k.allowed)return console.warn(`Rate limit exceeded for IP ${i} on route ${j}`),new d.NextResponse(JSON.stringify({ok:!1,error:"rate_limit",message:"Too many requests. Please try again later.",retryAfter:Math.ceil((k.resetTime-Date.now())/1e3)}),{status:429,headers:{"Content-Type":"application/json","Retry-After":String(Math.ceil((k.resetTime-Date.now())/1e3)),"X-RateLimit-Limit":String(e),"X-RateLimit-Remaining":String(k.remainingTokens),"X-RateLimit-Reset":String(Math.ceil(k.resetTime/1e3))}});let l=await b(a);return l.headers.set("X-RateLimit-Limit",String(e)),l.headers.set("X-RateLimit-Remaining",String(k.remainingTokens)),l.headers.set("X-RateLimit-Reset",String(Math.ceil(k.resetTime/1e3))),l}catch(c){return console.error("Rate limiting middleware error:",c),b(a)}}},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},39989:(a,b,c)=>{"use strict";c.d(b,{EF:()=>f,Uv:()=>e,Vm:()=>d,a0:()=>g});let d={NAME:{MIN_LENGTH:3,MAX_LENGTH:200},WINDOW:{MIN_DAYS:7,MAX_DAYS:1095},FEES:{MIN_BPS:0,MAX_BPS:100},SLIPPAGE:{MIN_BPS:0,MAX_BPS:50},SIZING:{MIN_PCT:.01,MAX_PCT:1},REBALANCE:{MIN_DAYS:1,MAX_DAYS:30},RULES:{MIN_COUNT:1,MAX_COUNT:10},AGENTS:{MIN_COUNT:1,MAX_COUNT:20}};class e extends Error{constructor(a,b,c){super(a),this.code=b,this.details=c,this.name="BacktestError"}}function f(a){return["BTC","ETH","NAV"].includes(a)}function g(a){return["queued","running","done","failed"].includes(a)}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56161:()=>{},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},92609:()=>{},99920:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>L,patchFetch:()=>K,routeModule:()=>G,serverHooks:()=>J,workAsyncStorage:()=>H,workUnitAsyncStorage:()=>I});var d={};c.r(d),c.d(d,{POST:()=>F});var e=c(70818),f=c(73659),g=c(27002),h=c(69532),i=c(40386),j=c(261),k=c(8404),l=c(92638),m=c(35254),n=c(92229),o=c(53203),p=c(29865),q=c(25183),r=c(7896),s=c(86439),t=c(15974),u=c(41315),v=c(39989);class w{static{this.OPERATORS={">":">",">=":">=","<":"<","<=":"<=","==":"==","!=":"!="}}static{this.LOGICAL_OPS={AND:"AND",OR:"OR","&&":"AND","||":"OR"}}static parseRule(a,b=1){try{let c=JSON.parse(a);return this.parseJSONRule(c,b,a)}catch{return this.parseStringRule(a,b)}}static parseJSONRule(a,b,c){if(a.and&&Array.isArray(a.and)){let d=a.and.map(this.parseCondition),e=Array(d.length-1).fill("AND");return{expressions:d,operators:e,weight:b,originalExpr:c}}if(a.or&&Array.isArray(a.or)){let d=a.or.map(this.parseCondition),e=Array(d.length-1).fill("OR");return{expressions:d,operators:e,weight:b,originalExpr:c}}return{expressions:[this.parseCondition(a)],operators:[],weight:b,originalExpr:c}}static parseStringRule(a,b){let c=[],d=[],e=a.split(/\s+(AND|OR|&&|\|\|)\s+/);for(let a=0;a<e.length;a+=2){let b=e[a]?.trim();if(b&&c.push(this.parseStringCondition(b)),a+1<e.length){let b=e[a+1]?.trim();b&&this.LOGICAL_OPS[b]&&d.push(this.LOGICAL_OPS[b])}}return{expressions:c,operators:d,weight:b,originalExpr:a}}static parseCondition(a){if("object"==typeof a&&a.field&&a.op&&void 0!==a.value)return{field:a.field,operator:a.op,value:a.value,dataType:"number"==typeof a.value?"number":"string"};throw Error(`Invalid JSON condition format: ${JSON.stringify(a)}`)}static parseStringCondition(a){let b=a.match(/^([a-zA-Z][a-zA-Z0-9_.]*)\s*(>=|<=|>|<|==|!=)\s*(.+)$/);if(!b)throw Error(`Invalid condition format: ${a}`);let[,c,d,e]=b,f=this.OPERATORS[d];if(!f)throw Error(`Invalid operator: ${d}`);let g=e.trim(),h="string";return/^-?\d*\.?\d+([eE][+-]?\d+)?$/.test(g)?(g=parseFloat(g),h="number"):g=g.replace(/^["']|["']$/g,""),{field:c,operator:f,value:g,dataType:h}}static evalRule(a,b){if(0===a.expressions.length)return!1;if(1===a.expressions.length)return this.evalExpression(a.expressions[0],b);let c=this.evalExpression(a.expressions[0],b);for(let d=0;d<a.operators.length;d++){let e=a.expressions[d+1],f=this.evalExpression(e,b);c="AND"===a.operators[d]?c&&f:c||f}return c}static evalExpression(a,b){let c=this.getNestedValue(b,a.field);if(null==c)return!1;let d=c,e=a.value;if("number"===a.dataType&&"number"!=typeof c&&isNaN(d=parseFloat(c)))return!1;switch("string"===a.dataType&&"string"!=typeof c&&(d=String(c)),a.operator){case">":return d>e;case">=":return d>=e;case"<":return d<e;case"<=":return d<=e;case"==":return d==e;case"!=":return d!=e;default:return!1}}static getNestedValue(a,b){return b.split(".").reduce((a,b)=>a&&"object"==typeof a?a[b]:void 0,a)}static validateRule(a){try{return this.parseRule(a),{valid:!0}}catch(a){return{valid:!1,error:a instanceof Error?a.message:"Unknown parsing error"}}}static getReferencedFields(a){return[...new Set(a.expressions.map(a=>a.field))]}}class x{static calculateKpis(a,b,c){if(a.length<2)throw Error("Need at least 2 equity points to calculate KPIs");let d=this.calculateReturns(a.map(a=>a.strat)),e=c.length>0?c:this.calculateReturns(a.map(a=>a.bench)),f=this.calculateTotalReturn(d),g=this.calculateAnnualizedReturn(d),h=this.calculateVolatility(d),i=this.calculateMaxDrawdown(a.map(a=>a.strat)),j=this.calculateSharpe(g,h),k=this.calculateHitRate(b),l=this.calculateExcessReturn(d,e);return{pnlUsd:b.reduce((a,b)=>a+b.realizedPnl,0),pnlPct:f,maxDDPct:i,sharpe:j,hitRate:k,trades:b.length,volPct:h,vsBenchmarkPct:l}}static calculateReturns(a){let b=[];for(let c=1;c<a.length;c++)a[c-1]>0?b.push((a[c]-a[c-1])/a[c-1]):b.push(0);return b}static calculateTotalReturn(a){return a.reduce((a,b)=>a*(1+b),1)-1}static calculateAnnualizedReturn(a){if(0===a.length)return 0;let b=this.calculateTotalReturn(a),c=a.length/252;return c<=0?b:Math.pow(1+b,1/c)-1}static calculateVolatility(a){if(a.length<2)return 0;let b=a.reduce((a,b)=>a+b,0)/a.length;return Math.sqrt(252*(a.reduce((a,c)=>a+Math.pow(c-b,2),0)/(a.length-1)))}static calculateMaxDrawdown(a){let b=0,c=a[0]||1;for(let d of a){d>c&&(c=d);let a=(d-c)/c;a<b&&(b=a)}return b}static calculateSharpe(a,b){return 0===b?0:a/b}static calculateHitRate(a){return 0===a.length?0:a.filter(a=>a.realizedPnl>0).length/a.length}static calculateExcessReturn(a,b){if(a.length!==b.length)return this.calculateTotalReturn(a)-this.calculateTotalReturn(b);let c=1,d=1;for(let e=0;e<a.length;e++)c*=1+a[e],d*=1+(b[e]||0);return c-1-(d-1)}static calculateMonthlyPnL(a){if(a.length<2)return[];let b=new Map;for(let c of a){let a=new Date(c.ts),d=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;b.has(d)?b.get(d).end=c.strat:b.set(d,{start:c.strat,end:c.strat})}return Array.from(b.entries()).map(([a,b])=>({ym:a,pnlPct:b.start>0?(b.end-b.start)/b.start:0})).sort((a,b)=>a.ym.localeCompare(b.ym))}static clampValue(a,b=-10,c=10){return isNaN(a)||!isFinite(a)?0:Math.max(b,Math.min(c,a))}static calculateRollingSharpe(a,b=63){let c=[];for(let d=b-1;d<a.length;d++){let e=a.slice(d-b+1,d+1),f=this.calculateAnnualizedReturn(e),g=this.calculateVolatility(e),h=this.calculateSharpe(f,g);c.push(this.clampValue(h,-5,5))}return c}static calculateVaR(a,b=.05){return 0===a.length?0:[...a].sort((a,b)=>a-b)[Math.floor(a.length*b)]||0}static calculateCalmar(a,b){return b>=0?0:a/Math.abs(b)}}class y{static calculateCoverage(a,b){return Math.min(b/a,1)}static validateDataQuality(a,b,c=.9){let d=[],e=this.calculateCoverage(b,a.length);e<c&&d.push(`Low data coverage: ${(100*e).toFixed(1)}% (expected >${(100*c).toFixed(0)}%)`),b<30&&d.push(`Short backtest period: ${b} days (minimum 30 days recommended)`);let f=a.map(a=>new Date(a.ts).getTime()),g=f.length>1?(f[f.length-1]-f[0])/(f.length-1):0;return g>1296e5&&d.push(`Large data gaps detected (avg: ${(g/864e5).toFixed(1)} days)`),d}}class z{static{this.CACHE_TTL=36e5}static{this.cache=new Map}static async getBenchmarkReturns(a,b,c){let d,e=`${a}_${b}_${c}`,f=this.cache.get(e);if(f&&Date.now()-f.timestamp<this.CACHE_TTL)return f.data;try{switch(a){case"BTC":d=await this.getBTCReturns(b,c);break;case"ETH":d=await this.getETHReturns(b,c);break;case"NAV":d=await this.getNAVReturns(b,c);break;default:throw Error(`Unsupported benchmark: ${a}`)}return this.cache.set(e,{data:d,timestamp:Date.now()}),d}catch(e){return console.error(`âŒ Error fetching ${a} benchmark data:`,e),console.warn(`âš ï¸ Using synthetic ${a} data as fallback`),d=this.generateSyntheticReturns(b,c,a)}}static async getBTCReturns(a,b){return this.queryMetricsTable("btc.close",a,b)}static async getETHReturns(a,b){return this.queryMetricsTable("eth.close",a,b)}static async getNAVReturns(a,b){try{return this.queryMetricsTable("nav.close",a,b)}catch{return this.generateFlatReturns(a,b)}}static async queryMetricsTable(a,b,c){let d=new Date(b),e=Math.ceil((new Date(c).getTime()-d.getTime())/864e5);return console.warn(`âš ï¸ Using mock data for ${a} - implement database query`),this.generateMockBenchmarkData(a,b,c,e)}static generateFlatReturns(a,b){let c=[],d=new Date(a),e=new Date(b),f=new Date(d);for(;f<=e;)c.push({date:f.toISOString().split("T")[0],price:1,return:0}),f.setDate(f.getDate()+1);return c}static generateSyntheticReturns(a,b,c){let d=[],e=new Date(a),f=new Date(b),g=5e4,h=.03;switch(c){case"ETH":g=3e3,h=.035;break;case"NAV":return this.generateFlatReturns(a,b)}let i=new Date(e),j=g;for(;i<=f;){let a=this.generateNormalRandom()*h+2e-4,b=j*(1+a);d.push({date:i.toISOString().split("T")[0],price:b,return:a}),j=b,i.setDate(i.getDate()+1)}return d}static generateMockBenchmarkData(a,b,c,d){let e=[],f=new Date(b),g=a.includes("btc")?45e3:2800;for(let b=0;b<d;b++){let c=new Date(f);c.setDate(f.getDate()+b);let d=this.generateRealisticReturn(a,b),h=g*(1+d);e.push({date:c.toISOString().split("T")[0],price:h,return:d}),g=h}return e}static generateRealisticReturn(a,b){let c=a.includes("btc")?.025:.03;return .001*Math.sin(2*b*Math.PI/365)+this.generateNormalRandom()*c}static generateNormalRandom(){return Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random())}static calculateReturnsFromPrices(a){let b=[];for(let c=1;c<a.length;c++){let d=a[c-1].price,e=a[c].price;d>0?b.push((e-d)/d):b.push(0)}return b}static validateBenchmarkData(a){let b=[];if(0===a.length)return{valid:!1,warnings:["No benchmark data available"]};let c=a.map(a=>new Date(a.date)),d=new Date(c[0]);for(let a=1;a<c.length;a++)d.setDate(d.getDate()+1),c[a].getTime()!==d.getTime()&&b.push(`Data gap detected around ${c[a].toISOString().split("T")[0]}`);let e=a.map(a=>a.price),f=a.map(a=>a.return),g=Math.max(...e),h=Math.min(...e),i=Math.max(...f),j=Math.min(...f);return(i>.5||j<-.5)&&b.push(`Extreme returns detected: ${(100*j).toFixed(1)}% to ${(100*i).toFixed(1)}%`),h<=0&&b.push("Non-positive prices detected in benchmark data"),g>0&&g>1e3*h&&b.push("Price range spans over three orders of magnitude; verify data normalization"),{valid:!0,warnings:b}}static clearCache(){this.cache.clear()}static getCacheStats(){let a=this.cache.size,b=JSON.stringify([...this.cache.values()]).length;return{keys:a,size:`${(b/1024).toFixed(1)} KB`}}}class A{constructor(a=1,b,c){this.position=0,this.nav=1,this.benchmarkNav=1,this.entryPrice=0,this.totalRealizedPnl=0,this.totalFees=0,this.totalSlippage=0,this.dailyResults=[],this.nav=a,this.benchmarkNav=a,this.costs=b,this.sizing=c}processDay(a,b,c,d,e){let f=this.calculateTargetPosition(b),g=this.executePositionChange(a,f,c),h=this.calculateUnrealizedPnL(c,e),i=g.reduce((a,b)=>a+b.realizedPnl,0),j=i+h;this.nav+=j,this.benchmarkNav=this.benchmarkNav*(1+d);let k=g.reduce((a,b)=>a+b.fees,0),l=g.reduce((a,b)=>a+b.slippage,0);this.totalFees+=k,this.totalSlippage+=l;let m={date:a,targetPosition:f,actualPosition:this.position,marketValue:this.position*c,realizedPnl:i,unrealizedPnl:h,totalPnl:j,fees:k,slippage:l,nav:this.nav,benchmark:this.benchmarkNav,trades:g};return this.dailyResults.push(m),m}calculateTargetPosition(a){let b=Math.max(0,Math.min(1,a))*this.sizing.notionalPctNAV*this.nav;return void 0!==this.sizing.minPosition&&(b=Math.max(b,this.sizing.minPosition)),void 0!==this.sizing.maxPosition&&(b=Math.min(b,this.sizing.maxPosition)),void 0!==this.sizing.maxLeverage&&(b=Math.min(b,this.nav*this.sizing.maxLeverage)),b}executePositionChange(a,b,c){let d=[],e=b-this.position;if(1e-6>=Math.abs(e))return d;let f=Math.abs(e)*c,g=f*(this.costs.feesBps/1e4);void 0!==this.costs.minFee&&(g=Math.max(g,this.costs.minFee));let h=f*(this.costs.slippageBps/1e4);void 0!==this.costs.maxSlippage&&(h=Math.min(h,this.costs.maxSlippage));let i=0;0!==this.position&&this.entryPrice>0&&(i=Math.min(Math.abs(e),Math.abs(this.position))*(c-this.entryPrice),this.position<0&&(i=-i));let j={timestamp:`${a}T00:00:00Z`,side:e>0?"BUY":"SELL",quantity:Math.abs(e),price:c,fees:g,slippage:h,realizedPnl:i-g-h,positionSize:b},k=this.position;if(this.position=b,0!==b){if(Math.sign(b)!==Math.sign(k)||0===k)this.entryPrice=c;else if(Math.abs(b)>Math.abs(k)){let a=Math.abs(b)-Math.abs(k),d=Math.abs(b);this.entryPrice=(this.entryPrice*Math.abs(k)+c*a)/d}}return this.totalRealizedPnl+=j.realizedPnl,d.push(j),d}calculateUnrealizedPnL(a,b){if(0===this.position||0===this.entryPrice)return 0;let c=a-this.entryPrice;return this.position*c}smoothPosition(a,b=.5){return 0===this.position?a:b*a+(1-b)*this.position}getResults(){return{dailyResults:[...this.dailyResults],totalRealizedPnl:this.totalRealizedPnl,totalFees:this.totalFees,totalSlippage:this.totalSlippage,finalNav:this.nav,finalBenchmark:this.benchmarkNav,finalPosition:this.position}}reset(a=1){this.position=0,this.nav=a,this.benchmarkNav=a,this.entryPrice=0,this.totalRealizedPnl=0,this.totalFees=0,this.totalSlippage=0,this.dailyResults=[]}getCurrentState(){return{position:this.position,nav:this.nav,benchmarkNav:this.benchmarkNav,totalPnl:this.totalRealizedPnl,totalCosts:this.totalFees+this.totalSlippage}}static validateCosts(a){let b=[];return(a.feesBps<0||a.feesBps>1e3)&&b.push("Fees must be between 0 and 1000 basis points"),(a.slippageBps<0||a.slippageBps>1e3)&&b.push("Slippage must be between 0 and 1000 basis points"),void 0!==a.minFee&&a.minFee<0&&b.push("Minimum fee cannot be negative"),void 0!==a.maxSlippage&&a.maxSlippage<0&&b.push("Maximum slippage cannot be negative"),{valid:0===b.length,errors:b}}static validateSizing(a){let b=[];return(a.notionalPctNAV<=0||a.notionalPctNAV>1)&&b.push("Notional % of NAV must be between 0 and 1"),void 0!==a.maxLeverage&&a.maxLeverage<=0&&b.push("Maximum leverage must be positive"),void 0!==a.minPosition&&a.minPosition<0&&b.push("Minimum position cannot be negative"),void 0!==a.maxPosition&&a.maxPosition<0&&b.push("Maximum position cannot be negative"),void 0!==a.minPosition&&void 0!==a.maxPosition&&a.minPosition>a.maxPosition&&b.push("Minimum position cannot be greater than maximum position"),{valid:0===b.length,errors:b}}}class B{static async run(a){console.log(`ðŸš€ Starting backtest: ${a.name}`);let b=Date.now();try{this.validateConfig(a);let c=this.parseRules(a.rules);console.log(`ðŸ“‹ Parsed ${c.length} rules`);let d=this.generateTimeGrid(a.window.from,a.window.to);console.log(`ðŸ“… Generated ${d.length} day time grid`);let e=await this.loadSignalData(a.agents,d);console.log(`ðŸ“¡ Loaded signal data for ${e.length} days`);let f=await z.getBenchmarkReturns(a.benchmark,a.window.from,a.window.to);console.log(`ðŸ“ˆ Loaded ${f.length} benchmark data points`);let g={feesBps:a.feesBps||5,slippageBps:a.slippageBps||3},h={notionalPctNAV:a.sizing.notionalPctNAV},i=new A(1,g,h),j=await this.executeBacktest({config:a,signalData:e,benchmarkData:f,parsedRules:c,simulator:i}),k=Date.now()-b;return console.log(`âœ… Backtest completed in ${k}ms`),j}catch(c){let a=Date.now()-b;throw console.error(`âŒ Backtest failed after ${a}ms:`,c),c}}static validateConfig(a){if(!a.name||0===a.name.length)throw Error("Backtest name is required");if(!a.agents||0===a.agents.length)throw Error("At least one agent is required");if(!a.rules||0===a.rules.length)throw Error("At least one rule is required");if(!a.window.from||!a.window.to)throw Error("Time window (from/to) is required");if(new Date(a.window.from)>=new Date(a.window.to))throw Error("From date must be before to date");if(a.sizing.notionalPctNAV<=0||a.sizing.notionalPctNAV>1)throw Error("Notional % of NAV must be between 0 and 1")}static parseRules(a){let b=[];for(let c of a)try{let a=w.parseRule(c.expr,c.weight||1);b.push(a)}catch(a){throw Error(`Failed to parse rule "${c.expr}": ${a instanceof Error?a.message:"Unknown error"}`)}return b}static generateTimeGrid(a,b){let c=[],d=new Date(a),e=new Date(b),f=new Date(d);for(f.setUTCHours(0,0,0,0);f<=e;)c.push(f.toISOString().split("T")[0]),f.setDate(f.getDate()+1);return[...new Set(c)].sort()}static async loadSignalData(a,b){let c=[];for(let d of b){let b={date:d,agentData:{},aggregatedScore:0};for(let c of a){let a=await this.loadAgentSignalsForDay(c,d);b.agentData[c]=a}c.push(b)}return c}static async loadAgentSignalsForDay(a,b){return console.warn(`âš ï¸ Using mock signal data for ${a} on ${b} - implement database query`),this.generateMockSignalData(a,b)}static generateMockSignalData(a,b){let c={};switch(a){case"OF-1":c.etf={flow:{usd:(Math.random()-.5)*2e8,net:(Math.random()-.5)*5e7,"5min":(Math.random()-.5)*1e7}};break;case"OC-1":c.tvl={total:5e10+1e10*Math.random(),change7d:(Math.random()-.5)*.2,change1d:(Math.random()-.5)*.05},c.onchain={active_addresses:8e5+2e5*Math.random(),tx_count:25e4+5e4*Math.random(),fees_usd:5e6+2e6*Math.random()};break;case"DV-1":c.funding={rate:(Math.random()-.5)*.001,oi:2e9+5e8*Math.random()},c.gamma={exposure:(Math.random()-.5)*1e8};break;case"NM-1":c.news={sentiment_score:2*Math.random()-1},c.social={sentiment_score:2*Math.random()-1},c.price={close:45e3+1e4*Math.random(),rsi_14:30+40*Math.random()};break;default:c.generic={signal_strength:Math.random(),confidence:.5+.5*Math.random()}}return c.volatility={"1h":.01+.03*Math.random(),"24h":.02+.04*Math.random()},c}static async executeBacktest(a){let{config:b,signalData:c,benchmarkData:d,parsedRules:e,simulator:f}=a,g=[],h=[],i=[],j=this.alignData(c,d);if(0===j.length)throw Error("No aligned data points found for backtest period");console.log(`ðŸ“Š Processing ${j.length} aligned data points`);for(let a=0;a<j.length;a++){let{signalDay:c,benchmarkDay:d,underlyingReturn:i}=j[a],k=this.evaluateRules(e,c.agentData),l=k;b.rebalanceDays&&b.rebalanceDays>1&&(l=.7*k+.5*(f.getCurrentState().position>0)*.3);let m=f.processDay(c.date,l,d.price,d.return,i);g.push({ts:`${c.date}T00:00:00Z`,nav:1,strat:m.nav,bench:m.benchmark}),h.push(...m.trades),a%50==0&&console.log(`ðŸ“ˆ Processed ${a+1}/${j.length} days, NAV: ${m.nav.toFixed(4)}`)}let k=j.map(a=>a.benchmarkDay.return),l=x.calculateKpis(g,h,k),m=x.calculateMonthlyPnL(g),n=Math.ceil((new Date(b.window.to).getTime()-new Date(b.window.from).getTime())/864e5);return i.push(...y.validateDataQuality(g,n)),l.trades<10&&i.push(`Low trade count: ${l.trades} (consider longer period or looser rules)`),Math.abs(l.maxDDPct)>.5&&i.push(`High maximum drawdown: ${(100*l.maxDDPct).toFixed(1)}% (consider risk management)`),console.log(`ðŸ“Š Final metrics - PnL: ${(100*l.pnlPct).toFixed(2)}%, Sharpe: ${l.sharpe.toFixed(2)}, MaxDD: ${(100*l.maxDDPct).toFixed(2)}%`),{kpis:l,equity:g,monthlyPnL:m,notes:i}}static alignData(a,b){let c=[],d=new Map(b.map(a=>[a.date,a]));for(let b of a){let a=d.get(b.date);a&&c.push({signalDay:b,benchmarkDay:a,underlyingReturn:a.return})}return c}static evaluateRules(a,b){let c=0,d=0;for(let e of a){let a=this.flattenAgentData(b);w.evalRule(e,a)&&(c+=e.weight),d+=e.weight}return d>0?c/d:0}static flattenAgentData(a){let b={};for(let[c,d]of Object.entries(a))this.flattenObject(d,"",b);return b}static flattenObject(a,b,c){for(let[d,e]of Object.entries(a)){let a=b?`${b}.${d}`:d;e&&"object"==typeof e&&!Array.isArray(e)?this.flattenObject(e,a,c):c[a]=e}}static validateResults(a){let{kpis:b}=a;Math.abs(b.pnlPct)>10&&console.warn(`âš ï¸ Extremely high return: ${(100*b.pnlPct).toFixed(1)}%`),Math.abs(b.maxDDPct)>.9&&console.warn(`âš ï¸ Extremely high drawdown: ${(100*b.maxDDPct).toFixed(1)}%`),Math.abs(b.sharpe)>10&&console.warn(`âš ï¸ Extremely high Sharpe ratio: ${b.sharpe.toFixed(2)}`),0===b.trades&&console.warn(`âš ï¸ No trades executed - check rules and signal data`)}}var C=c(25578);async function D(a){try{let b,c,{id:d,actor:e,force:f}=await a.json();if(!d||"number"!=typeof d)return u.NextResponse.json({success:!1,error:"Invalid or missing backtest ID"},{status:400});if(!e||"string"!=typeof e||0===e.trim().length)return u.NextResponse.json({success:!1,error:"Invalid or missing actor"},{status:400});let g=Date.now();console.log(`ðŸš€ Starting backtest run ${d} by ${e}${f?" (forced)":""}`);let h=await E(d);if(!h)throw new v.Uv(`Backtest with id ${d} not found`,"NOT_FOUND");if("queued"!==h.status)throw new v.Uv(`Cannot run backtest with status: ${h.status}. Must be 'queued'`,"INVALID_STATE");console.log(`ðŸš€ Starting real backtest execution for: ${h.name}`);let i="running";try{b=await B.run(h.config),i="done",console.log(`âœ… Backtest execution completed successfully`),console.log(`ðŸ“Š Results: PnL ${(100*b.kpis.pnlPct).toFixed(2)}%, Sharpe ${b.kpis.sharpe.toFixed(2)}, MaxDD ${(100*b.kpis.maxDDPct).toFixed(2)}%`)}catch(a){i="failed",c=a instanceof Error?a.message:"Unknown execution error",console.error(`âŒ Backtest execution failed:`,a)}let j=Date.now()-g,k={success:"done"===i,id:d,status:i,results:b,errorMessage:c,durationMs:j,message:"done"===i?`Backtest execution completed in ${j}ms`:`Backtest failed: ${c}`};return u.NextResponse.json(k,{status:"done"===i?200:500})}catch(a){if(console.error("âŒ Run backtest error:",a),a instanceof v.Uv)return u.NextResponse.json({success:!1,error:a.message},{status:400});return u.NextResponse.json({success:!1,error:"Internal server error while running backtest"},{status:500})}}async function E(a){return{id:a,name:`High-Performance Strategy ${a}`,createdAt:new Date(Date.now()-864e5).toISOString(),updatedAt:new Date().toISOString(),actor:"research@adaf.com",status:"queued",config:{name:`Strategy Config ${a}`,agents:["OF-1","OC-1","DV-1"],rules:[{expr:"etf.flow.usd > 100e6 AND tvl.change7d > 0",weight:.6,description:"Large ETF inflows with TVL growth"},{expr:"funding.rate < -0.01 OR gamma.exposure > 50e6",weight:.4,description:"Negative funding or high gamma exposure"}],window:{from:new Date(Date.now()-7776e6).toISOString(),to:new Date().toISOString()},benchmark:"BTC",sizing:{notionalPctNAV:.1},feesBps:5,slippageBps:3,rebalanceDays:1}}}async function F(a){return(0,C.YO)(a,D)}let G=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/research/backtest/run/route",pathname:"/api/research/backtest/run",filename:"route",bundlePath:"app/api/research/backtest/run/route"},distDir:".next-dev",relativeProjectDir:"",resolvedPagePath:"/home/parallels/Desktop/adaf-dashboard-pro/src/app/api/research/backtest/run/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:H,workUnitAsyncStorage:I,serverHooks:J}=G;function K(){return(0,g.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:I})}async function L(a,b,c){var d;let e="/api/research/backtest/run/route";"/index"===e&&(e="/");let g=await G.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||G.isDev||x||(F="/index"===(F=C)?"/":F);let H=!0===G.isDev||!E,I=E&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>G.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>G.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await G.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await G.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await G.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}}};var b=require("../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[246,6186,6674],()=>b(b.s=99920));module.exports=c})();